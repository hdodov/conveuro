!function(){"use strict";function e(e){this.elem=e,this.trigger=e,this.moving=!1,this.onStart=null,this.onMove=null,this.onStop=null,this.startHandler=function(e){e.preventDefault(),e.stopPropagation(),document.addEventListener("mousemove",this.moveHandler),document.addEventListener("mouseup",this.stopHandler),this.moving=!0,this.start(e)}.bind(this),this.moveHandler=function(e){this.move(e)}.bind(this),this.stopHandler=function(e){this.moving&&(document.removeEventListener("mouseup",this.stopHandler),document.removeEventListener("mousemove",this.moveHandler),this.moving=!1,this.stop(e))}.bind(this)}function t(e){this.container=e||document.body,this.loaded=!1,this.destroyed=!1,this.onDestroy=null,this.elem=document.createElement("div"),this.container.appendChild(this.elem),this.elem.classList.add("conveuro-dropdown","is-hidden"),this.elem.innerHTML='<p class="conveuro-title"></p><div class="conveuro-list"></div><div class="conveuro-error"></div><div class="conveuro-footer"><p class="js-conveuro-more">see more...</p><p class="js-conveuro-close">close</p></div>',this.title=this.elem.getElementsByClassName("conveuro-title")[0],this.list=this.elem.getElementsByClassName("conveuro-list")[0],this.errorContainer=this.elem.getElementsByClassName("conveuro-error")[0],this.btnMore=this.elem.getElementsByClassName("js-conveuro-more")[0],this.btnClose=this.elem.getElementsByClassName("js-conveuro-close")[0],this.btnMore.addEventListener("click",function(){this.btnMore.classList.add("is-hidden"),this.list.style.maxHeight=this.list.offsetHeight+"px",this.list.style.overflow="auto",this.list.childNodes.forEach(function(e){e.classList.remove("is-hidden")})}.bind(this)),this.btnClose.addEventListener("click",function(){this.close()}.bind(this))}function n(n,s){var i=new t;i.renderPlaceholderList(3),i.setTitle(s.title),i.setLoading(!0),i.setPosition(n[0]-i.elem.offsetWidth/2,n[1]+24),c.add(i,s.title),i.addClickClose();var o=new e(i.elem);o.trigger=i.title,o.init(),o.onStart=function(){i.removeClickClose(),i.elem.style.zIndex=d.dropdown.zIndex,d.dropdown.zIndex++},i.onDestroy=function(){c.remove(i),o.destroy()},chrome.runtime.sendMessage({getRates:!0,currency:s.currency,value:s.value},function(e){i.destroyed||(i.setLoaded(!0),e.list?i.renderList(e.list):i.renderError(e))}),setTimeout(function(){i.show()},150)}function s(e){var t={commonAncestorText:l(e.commonAncestorContainer),selectedText:a(e),startContainerText:null,endContainerText:null};e.startContainer!==e.endContainer&&(t.startContainerText=l(e.startContainer),t.endContainerText=l(e.endContainer)),"string"==typeof t.startContainerText&&e.startContainer.nodeType==Node.TEXT_NODE&&(t.startContainerText=t.startContainerText.substr(e.startOffset)),"string"==typeof t.endContainerText&&e.endContainer.nodeType==Node.TEXT_NODE&&(t.endContainerText=t.endContainerText.substr(0,e.endOffset));for(var n in t)t[n]=i(t[n]);return t}function i(e){return"string"==typeof e&&e.length<d.maxTextLength?e:null}function o(e){for(var t=e.parentElement,n=0;t;){if(t.classList.contains(d.dropdown.class))return!0;if(t=t.parentElement,++n>=d.dropdown.maxDepth)break}return!1}function r(){for(var e=window.getSelection(),t=0;t<e.rangeCount;t++){var n=e.getRangeAt(t);if(!n.collapsed)return n}}function l(e){return e.nodeType===Node.TEXT_NODE?e.wholeText:e.innerText}function a(e){var t=[],n=!1,s="",i="";e.startContainer===e.endContainer?t=[e.commonAncestorContainer]:e.startContainer.parentElement===e.commonAncestorContainer&&(t=e.commonAncestorContainer.childNodes);for(var o=0;o<t.length&&(t[o]===e.startContainer&&(n=!0),n&&(s=l(t[o]),t[o].nodeType===Node.TEXT_NODE&&(t[o]===e.endContainer&&(s=s.substr(0,e.endOffset)),t[o]===e.startContainer&&(s=s.substr(e.startOffset))),i+=s),t[o]!==e.endContainer);o++);return i}var d={maxTextLength:140,dropdown:{class:"conveuro-dropdown",maxDepth:4,zIndex:214748e4}};e.prototype={init:function(){this.previousTriggerCursor=this.trigger.style.cursor,this.trigger.style.cursor="move",this.trigger.addEventListener("mousedown",this.startHandler)},start:function(e){var t=parseInt(this.elem.style.left),n=parseInt(this.elem.style.top);this.offset={x:e.pageX-t,y:e.pageY-n},"function"==typeof this.onStart&&this.onStart(e)},move:function(e){var t=e.pageX,n=e.pageY;this.offset&&(t-=this.offset.x,n-=this.offset.y),this.elem.style.left=t+"px",this.elem.style.top=n+"px","function"==typeof this.onMove&&this.onMove(e)},stop:function(e){"function"==typeof this.onStop&&this.onStop(e)},destroy:function(){this.trigger.style.cursor=this.previousTriggerCursor,this.trigger.removeEventListener("mousedown",this.startHandler),this.stopHandler(),this.elem=null,this.target=null,this.offset=null,this.onStart=null,this.onMove=null,this.onStop=null}};var c=function(){function e(e){for(var n=0;n<t.length;n++)if(t[n].title==e)return!0;return!1}var t=[];return{exists:e,add:function(n,s){return!e(s)&&(t.push({instance:n,title:s}),!0)},remove:function(e){for(var n=t.length-1;n>=0;n--)t[n].instance===e&&t.splice(n,1)}}}();t.prototype={setPosition:function(e,t){this.elem.style.left=e+"px",this.elem.style.top=t+"px"},createListItem:function(e){var t=document.createElement("div");return t.innerHTML="<p>"+e.value+'</p><small title="'+e.name+'">'+e.rate+" "+e.currency+"</small>",t},renderList:function(e){this.list.innerHTML="",this.btnMore.classList.add("is-hidden"),e.forEach(function(e,t){var n=this.createListItem(e);this.list.appendChild(n),t>=3&&(n.classList.add("is-hidden"),this.btnMore.classList.remove("is-hidden"))}.bind(this))},renderPlaceholderList:function(e){var t={value:"----------",rate:"-------",currency:"----"};this.list.innerHTML="",this.btnMore.classList.add("is-hidden");for(var n=0;n<e;n++)this.list.appendChild(this.createListItem(t))},renderError:function(e){this.renderList([]),this.errorContainer.innerHTML="",e.code&&(this.errorContainer.innerHTML+='<p class="code">'+e.code+"</p>"),e.message&&(this.errorContainer.innerHTML+='<p class="message">'+e.message+"</p>")},setTitle:function(e){this.title.innerHTML=e},setLoaded:function(e){this.loaded=e,!0===e&&this.setLoading(!1)},setLoading:function(e){!0!==e||this.loaded?this.elem.classList.remove("is-loading"):this.elem.classList.add("is-loading")},addClickClose:function(){this.clickCloseHandler=function(e){o(e.target)||this.close()}.bind(this),document.addEventListener("click",this.clickCloseHandler)},removeClickClose:function(){"function"==typeof this.clickCloseHandler&&(document.removeEventListener("click",this.clickCloseHandler),this.clickCloseHandler=null)},show:function(){this.elem.classList.remove("is-hidden")},close:function(){this.elem.classList.add("is-closed"),setTimeout(function(){this.destroy()}.bind(this),500)},destroy:function(){this.destroyed||(this.container.removeChild(this.elem),this.removeClickClose(),this.container=null,this.elem=null,this.title=null,this.list=null,this.errorContainer=null,this.btnMore=null,this.btnClose=null,this.destroyed=!0,"function"==typeof this.onDestroy&&this.onDestroy())}},document.addEventListener("mouseup",function(e){var t=r();if(t&&!o(t.startContainer)&&!o(t.endContainer)){var i=s(t),l=!1;for(var a in i)if(null!==i[a]){l=!0;break}l&&chrome.runtime.sendMessage({getWorthy:!0,data:i},function(t){t&&!c.exists(t.title)&&n([e.pageX,e.pageY],t)})}})}();