!function(){"use strict";var o={maxTextLength:140,dropdown:{class:"conveuro-dropdown",maxDepth:4,zIndex:214748e4}};function r(t){this.elem=t,this.trigger=t,this.moving=!1,this.onStart=null,this.onMove=null,this.onStop=null,this.startHandler=function(t){t.preventDefault(),t.stopPropagation(),document.addEventListener("mousemove",this.moveHandler),document.addEventListener("mouseup",this.stopHandler),this.moving=!0,this.start(t)}.bind(this),this.moveHandler=function(t){this.move(t)}.bind(this),this.stopHandler=function(t){this.moving&&(document.removeEventListener("mouseup",this.stopHandler),document.removeEventListener("mousemove",this.moveHandler),this.moving=!1,this.stop(t))}.bind(this)}r.prototype={init:function(){this.previousTriggerCursor=this.trigger.style.cursor,this.trigger.style.cursor="move",this.trigger.addEventListener("mousedown",this.startHandler)},start:function(t){var e=parseInt(this.elem.style.left),n=parseInt(this.elem.style.top);this.offset={x:t.pageX-e,y:t.pageY-n},"function"==typeof this.onStart&&this.onStart(t)},move:function(t){var e=t.pageX,n=t.pageY;this.offset&&(e-=this.offset.x,n-=this.offset.y),this.elem.style.left=e+"px",this.elem.style.top=n+"px","function"==typeof this.onMove&&this.onMove(t)},stop:function(t){"function"==typeof this.onStop&&this.onStop(t)},destroy:function(){this.trigger.style.cursor=this.previousTriggerCursor,this.trigger.removeEventListener("mousedown",this.startHandler),this.stopHandler(),this.elem=null,this.target=null,this.offset=null,this.onStart=null,this.onMove=null,this.onStop=null}};var l=function(){var n=[];function i(t){for(var e=0;e<n.length;e++)if(n[e].title==t)return!0;return!1}return{exists:i,add:function(t,e){return!i(e)&&(n.push({instance:t,title:e}),!0)},remove:function(t){for(var e=n.length-1;0<=e;e--)n[e].instance===t&&n.splice(e,1)}}}();function a(t){this.container=t||document.body,this.loading=!1,this.destroyed=!1,this.requestTimestamp=null,this.onDestroy=null,this.elem=document.createElement("div"),this.container.appendChild(this.elem),this.elem.classList.add("conveuro-dropdown","is-hidden"),this.elem.innerHTML='<p class="conveuro-title"></p><div class="conveuro-list"></div><div class="conveuro-error"></div><div class="conveuro-footer"><p class="js-conveuro-more">see more...</p><p class="js-conveuro-close">close</p></div>',this.title=this.elem.getElementsByClassName("conveuro-title")[0],this.list=this.elem.getElementsByClassName("conveuro-list")[0],this.errorContainer=this.elem.getElementsByClassName("conveuro-error")[0],this.btnMore=this.elem.getElementsByClassName("js-conveuro-more")[0],this.btnClose=this.elem.getElementsByClassName("js-conveuro-close")[0],this.btnMore.addEventListener("click",function(){this.btnMore.classList.add("is-hidden"),this.list.style.maxHeight=this.list.offsetHeight+"px",this.list.style.overflow="auto",this.list.childNodes.forEach(function(t){t.classList.remove("is-hidden")})}.bind(this)),this.btnClose.addEventListener("click",function(){this.close()}.bind(this))}function d(t){return"string"==typeof t&&t.length<o.maxTextLength?t:null}function c(t){for(var e=t.parentElement,n=0;e;){if(e.classList.contains(o.dropdown.class))return!0;if(e=e.parentElement,++n>=o.dropdown.maxDepth)break}return!1}function h(t){return t.nodeType===Node.TEXT_NODE?t.wholeText:t.innerText}a.prototype={requestData:function(e){this.setLoading(!0),this.setTitle(e.title);var t={};t[e.currency]=!0,chrome.runtime.sendMessage({id:"get_currencies",currencies:t},function(t){this.title.title=t[e.currency].name}.bind(this));var n=Date.now();this.requestTimestamp=n,e.list&&e.list.length?(this.renderList(e.list),chrome.runtime.sendMessage({id:"fill_list",list:e.list,base:e.currency,value:e.value},function(t){this.requestTimestamp!==n||this.destroyed||this.handleData(t)}.bind(this))):this.renderError({error:"No currencies to convert."})},handleData:function(t){this.setLoading(!1),t.list?this.renderList(t.list):this.renderError(t)},setPosition:function(t,e){this.elem.style.left=t+"px",this.elem.style.top=e+"px"},setTitle:function(t){this.title.innerHTML=t},setLoading:function(t){this.loading=t,!0===this.loading?this.elem.classList.add("is-loading"):this.elem.classList.remove("is-loading")},createListItem:function(t){var e=document.createElement("div"),n=t.name||"",i=t.value||"-------",s=t.rate||"----",o=t.code||"---";return e.innerHTML="<p>"+i+'</p><small title="'+n+'">'+s+" "+o+"</small>",e},renderList:function(t){this.emptyContent(),t.forEach(function(t,e){var n=this.createListItem(t);this.list.appendChild(n);var i=n.querySelector("p");i.offsetWidth<i.scrollWidth&&(n.classList.add("is-overflowing"),n.title=i.innerHTML),3<=e&&(n.classList.add("is-hidden"),this.loading||this.btnMore.classList.remove("is-hidden"))}.bind(this))},renderError:function(t){this.emptyContent(),t.code&&(this.errorContainer.innerHTML+='<p class="code">'+t.code+"</p>"),t.error&&(this.errorContainer.innerHTML+='<p class="message">'+t.error+"</p>")},addClickClose:function(){this.clickCloseHandler=function(t){c(t.target)||this.close()}.bind(this),document.addEventListener("click",this.clickCloseHandler)},removeClickClose:function(){"function"==typeof this.clickCloseHandler&&(document.removeEventListener("click",this.clickCloseHandler),this.clickCloseHandler=null)},show:function(){this.elem.classList.remove("is-hidden")},close:function(){this.elem.classList.add("is-closed"),setTimeout(function(){this.destroy()}.bind(this),500)},emptyContent:function(){this.list.innerHTML="",this.errorContainer.innerHTML="",this.btnMore.classList.add("is-hidden")},destroy:function(){this.destroyed||(this.container.removeChild(this.elem),this.removeClickClose(),this.container=null,this.elem=null,this.title=null,this.list=null,this.errorContainer=null,this.btnMore=null,this.btnClose=null,this.destroyed=!0,"function"==typeof this.onDestroy&&this.onDestroy())}},document.addEventListener("mouseup",function(e){var t=function(){for(var t=window.getSelection(),e=0;e<t.rangeCount;e++){var n=t.getRangeAt(e);if(!n.collapsed)return n}}();if(t&&!c(t.startContainer)&&!c(t.endContainer)){var n=function(t){var e={commonAncestorText:h(t.commonAncestorContainer),selectedText:function(t){var e=[],n=!1,i="",s="";t.startContainer===t.endContainer?e=[t.commonAncestorContainer]:t.startContainer.parentElement===t.commonAncestorContainer&&(e=t.commonAncestorContainer.childNodes);for(var o=0;o<e.length&&(e[o]===t.startContainer&&(n=!0),n&&(i=h(e[o]),e[o].nodeType===Node.TEXT_NODE&&(e[o]===t.endContainer&&(i=i.substr(0,t.endOffset)),e[o]===t.startContainer&&(i=i.substr(t.startOffset))),s+=i),e[o]!==t.endContainer);o++);return s}(t),startContainerText:null,endContainerText:null};t.startContainer!==t.endContainer&&(e.startContainerText=h(t.startContainer),e.endContainerText=h(t.endContainer));"string"==typeof e.startContainerText&&t.startContainer.nodeType==Node.TEXT_NODE&&(e.startContainerText=e.startContainerText.substr(t.startOffset));"string"==typeof e.endContainerText&&t.endContainer.nodeType==Node.TEXT_NODE&&(e.endContainerText=e.endContainerText.substr(0,t.endOffset));for(var n in e)e[n]=d(e[n]);return e}(t),i=!1;for(var s in n)if(null!==n[s]){i=!0;break}i&&chrome.runtime.sendMessage({id:"detect_data",data:n},function(t){t&&!l.exists(t.title)&&function(t,e){var n=new a;n.setPosition(t[0]-n.elem.offsetWidth/2,t[1]+24),l.add(n,e.title),n.addClickClose();var i=new r(n.elem);i.trigger=n.title,i.init(),i.onStart=function(){n.removeClickClose(),n.elem.style.zIndex=o.dropdown.zIndex,o.dropdown.zIndex++},n.onDestroy=function(){l.remove(n),i.destroy()},n.requestData(e),setTimeout(function(){n.show()},150)}([e.pageX,e.pageY],t)})}})}();